name: CI
on: [push]

jobs:
  ci:
    runs-on: ubuntu-latest
    container: node:15

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: graphql-boilerplate-ci
          POSTGRES_USER: graphql-boilerplate-ci
          POSTGRES_DB: graphql-boilerplate-ci
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v1

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Generate codegen
      run: yarn codegen
    
    - name: Typecheck
      run: yarn typescript-check --noEmit
    
    - name: Lint
      run: yarn lint

    - name: Schema validation
      run: yarn validate-schema
    
    - name: Database Migration Latest
      run: yarn database:migrate:latest
      env:
        DATABASE_TYPE: pg
        DATABASE_HOST: postgres
        DATABASE_USER: graphql-boilerplate-ci
        DATABASE_PORT: 5432
        DATABASE_PASSWORD: graphql-boilerplate-ci
        DATABASE_DATABASE_NAME: graphql-boilerplate-ci

    - name: Database Seed
      run: yarn seed
      env:
        DATABASE_TYPE: pg
        DATABASE_HOST: postgres
        DATABASE_USER: graphql-boilerplate-ci
        DATABASE_PORT: 5432
        DATABASE_PASSWORD: graphql-boilerplate-ci
        DATABASE_DATABASE_NAME: graphql-boilerplate-ci

    - name: Database Migration Rollback
      run: yarn database:migrate:rollback
      env:
        DATABASE_TYPE: pg
        DATABASE_HOST: postgres
        DATABASE_USER: graphql-boilerplate-ci
        DATABASE_PORT: 5432
        DATABASE_PASSWORD: graphql-boilerplate-ci
        DATABASE_DATABASE_NAME: graphql-boilerplate-ci


    - name: Tests
      run: yarn test
      env:
        DATABASE_USER: graphql-boilerplate-ci
        DATABASE_PORT: 5432
        DATABASE_HOST: postgres
        DATABASE_PASSWORD: graphql-boilerplate-ci
        DATABASE_DATABASE_NAME: graphql-boilerplate-ci

    - name: Check for non generated files
      run: git diff --exit-code

